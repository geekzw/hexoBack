---
title: 类加载
date: 2016-11-10 11:20:30
categories: JVM
tags:
---
类从被加载到虚拟机内存中开始，到卸载出内存为止，它的整个生命周期包括：加载、验证、准备、解析、初始化、使用、卸载7个阶段。其中验证、准备、解析3个部分统称为链接。加载、验证、准备、初始化和卸载这5个阶段顺序是确定的，类的加载过程必须按照这种顺序按部就班的开始，而解析阶段不一定，它可能在初始化后面（运行时绑定）。
<!-- more -->
## 概述
类从被加载到虚拟机内存中开始，到卸载出内存为止，它的整个生命周期包括：加载、验证、准备、解析、初始化、使用、卸载7个阶段。其中验证、准备、解析3个部分统称为链接。加载、验证、准备、初始化和卸载这5个阶段顺序是确定的，类的加载过程必须按照这种顺序按部就班的开始，而解析阶段不一定，它可能在初始化后面（运行时绑定）。
## 触发条件
### 一、 加载，验证，准备
这几个过程，在虚拟机规范中并没有明确规定开始时间和条件，要根据虚拟机具体实现确定。
### 二、 初始化

#### 主动初始化
1. 当使用new关键字实例化对象、读取或设置静态字段、调用静态方法的时候，如果类没有被初始化，那么要执行初始化操作
1. 反射调用时，如果类没有被初始化，那么要执行初始化操作
1. 初始化一个类时，如果父类没有被初始化，那么需要先触发父类的初始化
1. 虚拟机启动时，需要先初始化包含main()的主类
5. 当使用JDK1.7的动态语言支持时，如果一个java.lang.invoke.MethodHandle实例解析结果REF_getStatic、REF_putStatic、REF_invokeStatic的方法句柄，并且这个句柄锁对应的类没有进行过初始化，则需要先触发其初始化
#### 被动初始化
**除了上面5种触发初始化的场景，其他的引用类的方式都不会触发初始化，称为被动初始化**

1. 通过子类引用父类的静态字段，不会导致子类初始化，对于静态字段，只有直接定义这个字段的类才会被初始化
2. 通过数组定义来引用类，不会触发此类的初始化。（个人理解：当定义一个类型的数组时，这个变量代表的是数组本身，无论是我们所能调用的方法或属性，都与具体的类无关，如果说初始化，也是对数组本身这个类初始化，不会初始化所能存放的类型的类）
3. 常量在比哪一阶段会存入调用类的常量池中，因此调用常量，不会触发定义常量的类的初始化
接口与类的最大不同点在于，当一个类初始化时，要求它的父类全部初始化成功，但接口没有此要求，只有在真正用到父类的时候，才会要求初始化

## 类的加载过程
### 加载
加载需要完成3件事
1. 通过一个类的全限定名来获取此类的二进制字节流
2. 将字节流代表的静态存储结构转化为方法区的运行时数据结构
3. 在内存（HotSpot虚拟机是放在方法区）中生成一个代表这个类的Class对象，作为方法区这个类的各种数据的访问入口

**上述3点中，第一点具有极大的灵活性，因为虚拟机只规定获取二进制字节流，并没有规定获取的方式，所以才有了现在的从ZIP,WAR,JAR,网络等各个渠道。类加载阶段（非数组类）是可控性最强的地方，我们可以选择用系统提供的引导类加载器，也可以自定义类加载器。类加载完成之后，产生的结果就是把二进制流按照虚拟机所需格式存储在方法区。然后内存中生成一个Class对象作为程序方位的外部接口。**
连接和连接阶段的部分内容是交叉进行的，只是开始动作按先后顺序
### 验证
**验证的主要作用是确保Class文件的字节流中包含的信息符合当前虚拟机的要求，防止危害虚拟机自身安全严恒主要分为4个阶段**
1. 文件格式验证
改阶段的验证主要目的是保证输入的字节流能正确地解析并存储于方法区之内
主要验证点有：是否以魔数0xCAFEBABE开头，常量池的常量是否有不被支持的常量类型等
2. 元数据验证
对字节码描述的信息进行语义分析，保证其描述的信息符合java语言规范
主要验证点：这个类是否有父类，是否继承自不允许继承的类类中字段、方法是否与父类矛盾等
3. 字节码验证
对类的方法体进行效验分析，保证被效验类的方法在运行时不会做出危害虚拟机的事件
主要验证点：保证跳转指令不会跳转到方法体以外的字节码指令上，保证方法体中的类型转换的有效性等
4. 符号引用验证
可以看做是对类自身以外的信息进行匹配性效验
主要验证点：符号引用中通过字符串面熟的全限定名是否能找到对应的类等

### 准备
准备阶段的主要工作是在方法区中给变量分配内存，并设置类变量初始值。这里强调的是类变量，和初始值。实例变量则在初始化阶段进行。初始值表示的是零值，例如public static int value = 123；在准备阶段只会赋值为0，初始化阶段才会赋值为123

### 解析
#### 符号引用
符号引用以一组符号来描述所引用的目标，可以是任何形式的字面量，只要使用时能无歧义的定位到目标即可。符号引用与虚拟机内存布局无关，引用的目标不一定已经加载到内存中

#### 直接引用
直接引用可以使直接指向目标的指针、相对偏移量或者是一个能间接定位到目标的句柄，直接引用是和虚拟机实现的内存布局相关的，有了直接引用，目标必定已经在内存中。
**解析阶段是虚拟机讲常量池内的符号引用替换为直接引用的过程**

### 初始化
初始化是类加载的最后一个阶段了。简单来说，初始化阶段就是执行init()方法的阶段，init方法的生成是由编译器自动收集勒种的所有类变量的赋值动作和静态语句块中的语句合并产生的。收集顺序是按语句在源文件中出现的顺序决定的。init方法不一定会有，如果类中没有静态变量和静态语句块，则不会生成init方法
