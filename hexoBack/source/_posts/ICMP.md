---
title: ICMP
date: 2016-12-02 13:54:19
categories: net
tags: net
description: "ICMP全称：Internet Control Message Protocol 翻译过来就是网际控制报文协议。目的是有效的转发IP数据报和提高交付成功的机会。ICMP不是高层协议，是IP层的协议。ICMP报文作为IP数据报的数据，加上数据报的首部组成IP数据报发送出去"
---
ICMP全称：Internet Control Message Protocol 翻译过来就是网际控制报文协议。目的是有效的转发IP数据报和提高交付成功的机会。ICMP不是高层协议，是IP层的协议。ICMP报文作为IP数据报的数据，加上数据报的首部组成IP数据报发送出去
<!-- more -->
## ICMP概念
ICMP全称：Internet Control Message Protocol 翻译过来就是网际控制报文协议。目的是有效的转发IP数据报和提高交付成功的机会。ICMP不是高层协议，是IP层的协议。ICMP报文作为IP数据报的数据，加上数据报的首部组成IP数据报发送出去
![ICMP报文格式][1]
## ICMP种类
ICMP报文有两种：ICMP差错报告报文和ICMP询问报文
![ICMP报文类型][2]
* 终点不可达：当路由器或主机不能交付数据时就向源点发送此报告
* 源点抑制：当路由或主机由于拥塞而丢失数据的时候，向源点发送此报告，使源点知道应该把数据报的速率放慢
* 时间超过：当路由器收到时间为0的数据报时除丢弃数据报外，还要向源点发送此报文。当终点在预定的时间内没有收到全部数据时，会丢弃已收到的所有数据并向源点发送此报文
* 参数问题：当路由或目的主机收到的数据有问题时发送
* 改变路由：路由把改变路由报文发给源主机，让主机知道下次应该用哪个路由
每个主机都有个默认路由，初始时，主机总是把数据发给默认路由，由默认路由寻找合适的路由或主机转发，当默认路由找到合适的路由，并认为以后主机应该直接发给那个路由，不用通过默认路由的时候，就会给源主机发送改变路由的报文，源主机在自己的路由表中增加一个项目，以后就会直接发给相应的路由
## ICMP应用
在window系统中，我们常用的ping命令，就是ICMP。当执行ping命令的时候，PC机会一连发出多条回送请求报文
还有个非常有用的功能是 tracert，就是跟踪源主机到目的主机的路径。
实现方式：
tracerout向目的主机发送一连串的IP数据，都是不可交付的UDP数据。第一个的TTL设置为1，当第一个路由接收到后TTl-1，变成0，则丢弃数据；第二次TTL设置成2，当第二个路由收到后，TTL变为0，丢弃数据。这样一直到目的主机（目的主机无法对TTL操作，但是由于发送的是不可交付的UDP数据，因此会向源主机发送中点不可达的ICMP）。由于每次TTL变为0，数据时间超过，会给源主机发送时间超过的ICMP报文，则源主机就记住了从源主机到目的主机的路径


  [1]: http://ofy9dm2ii.bkt.clouddn.com/icmp1.png
  [2]: http://ofy9dm2ii.bkt.clouddn.com/image/article/icmp2.png
